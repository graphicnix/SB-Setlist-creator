<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpiralBound Setlist Creator</title>
    <style>
        /* Previous styles remain unchanged except for these additions/updates */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            max-width: 100%;
            overflow-x: hidden;
            background-color: #565656;
            color: #fff;
            position: relative; /* For positioning tooltips */
        }
        h1 {
            text-align: center;
            margin-bottom: 40px;
        }
        .icon-legend-container {
            display: flex;
            justify-content: space-between;
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
        }
        .crossfade-btn {
            padding: 5px 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .crossfade-btn:hover {
            background: #45a049;
        }
        .crossfade-popup {
            display: none;
            position: fixed;
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            color: #000;
        }
        .crossfade-popup label {
            display: block;
            margin: 5px 0;
        }
        .welcome-popup, .instructions-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            z-index: 1000;
            color: #000;
            max-width: 400px;
            text-align: center;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <script>
        const correctPassword = "haircut";
        let userPassword = localStorage.getItem('sitePassword');
        if (!userPassword || userPassword.toLowerCase() !== correctPassword) {
            userPassword = prompt("Enter the password to access this site:");
            if (userPassword && userPassword.toLowerCase() !== correctPassword) {
                document.body.innerHTML = "<h1>Access Denied</h1>";
                throw new Error("Incorrect password");
            } else if (userPassword) {
                localStorage.setItem('sitePassword', userPassword);
            }
        }

        // Welcome popup
        if (!localStorage.getItem('welcomeShown')) {
            document.body.insertAdjacentHTML('beforeend', `
                <div class="overlay"></div>
                <div class="welcome-popup">
                    <h3>Welcome to SpiralBound Setlist Creator</h3>
                    <p>To save changes to GitHub, you'll need a personal access token from Weston.</p>
                    <button onclick="this.parentElement.remove(); document.querySelector('.overlay').remove(); localStorage.setItem('welcomeShown', 'true')">Got it!</button>
                </div>
            `);
        }

        // Instructions tooltip popup (shows for 10 seconds)
        setTimeout(() => {
            document.body.insertAdjacentHTML('beforeend', `
                <div class="instructions-popup">
                    <p><strong>How to Use:</strong><br>
                    - Drag songs to a setlist or click "Add"<br>
                    - Click "Save Setlist" to name and store<br>
                    - Click "Print/Share" to generate a printable view</p>
                </div>
            `);
            setTimeout(() => {
                document.querySelector('.instructions-popup')?.remove();
            }, 10000);
        }, 1000);
    </script>

    <div class="icon-legend-container">
        <div class="tooltip">Icon Legend
            <span class="tooltiptext">
                <strong class="icon-O">O</strong> = Easy Vocals (Blue)<br>
                <strong class="icon-X">X</strong> = Hard Vocals (Red)<br>
                <strong class="icon-G">G</strong> = Guitar Change (Brown)<br>
                <strong class="icon-M">M</strong> = Backup Vocals (Orange)<br>
                <strong class="icon-→">→</strong> = Crossfade (Black)
            </span>
        </div>
        <div class="tooltip">Icon Legend
            <span class="tooltiptext">
                <strong class="icon-O">O</strong> = Easy Vocals (Blue)<br>
                <strong class="icon-X">X</strong> = Hard Vocals (Red)<br>
                <strong class="icon-G">G</strong> = Guitar Change (Brown)<br>
                <strong class="icon-M">M</strong> = Backup Vocals (Orange)<br>
                <strong class="icon-→">→</strong> = Crossfade (Black)
            </span>
        </div>
    </div>

    <button class="sync-btn" onclick="saveData()">Save and Sync</button>
    <a href="https://spiralbound.lol/" class="spiralbound-btn">Visit Spiralbound</a>
    <img src="500x300.spiralbound.logo.png" alt="Spiralbound Logo" class="logo">

    <h1>SpiralBound Setlist Creator</h1>

    <div class="category">
        <h2>Alternative/Grunge/Rock</h2>
        <table id="alternative-grunge-rock">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'alternative-grunge-rock')">Song Title</th>
                    <th onclick="sortTable(1, 'alternative-grunge-rock')">Artist</th>
                    <th onclick="sortTable(2, 'alternative-grunge-rock')">Key</th>
                    <th onclick="sortTable(3, 'alternative-grunge-rock')">Riff</th>
                    <th onclick="sortTable(4, 'alternative-grunge-rock')">BPM</th>
                    <th onclick="sortTable(5, 'alternative-grunge-rock')">Duration</th>
                    <th>Crossfade Options</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="song-table-body"></tbody>
        </table>
    </div>

    <!-- Setlists remain unchanged -->

    <div id="saved-setlists" class="category"></div>

    <div class="add-song">
        <!-- Add song section remains unchanged -->
    </div>

    <a href="https://spiralbound.lol/" class="spiralbound-btn">Visit Spiralbound</a>
    <button class="sync-btn" onclick="saveData()">Save and Sync</button>

    <script>
        // Previous script variables and functions remain largely unchanged except for these updates

        function populateSongTable() {
            const tbody = document.getElementById('song-table-body');
            tbody.innerHTML = '';
            for (const song in songData) {
                const songInfo = songData[song];
                const [title, artist] = song.split(' - ');
                const iconsHtml = (songIcons[song] || []).filter(i => i).map(icon => 
                    `<span class="icon-${icon}">${icon}</span>`).join(' ');
                const row = document.createElement('tr');
                row.setAttribute('data-song', song);
                row.innerHTML = `
                    <td class="song-cell">
                        <div class="icons">${iconsHtml}</div>
                        <div class="song-title" style="cursor: pointer;" onclick="openLyrics('${song}')">${title}</div>
                    </td>
                    <td>${artist}</td>
                    <td>${songInfo.key}</td>
                    <td>${songInfo.riff}</td>
                    <td>${songInfo.bpm}</td>
                    <td>${songInfo.duration}</td>
                    <td>
                        <button class="crossfade-btn" onclick="showCrossfadePopup('${song}', this)">Select Crossfades</button>
                        <div class="crossfade-popup" id="crossfade-${song.replace(/[^a-zA-Z0-9]/g, '')}">
                            ${Object.keys(songData).filter(s => s !== song).map(s => `
                                <label><input type="checkbox" value="${s}" 
                                    ${songInfo.crossfadeInto.includes(s) ? 'checked' : ''} 
                                    onchange="updateCrossfade('${song}', this)"> ${s}</label>
                            `).join('')}
                        </div>
                    </td>
                    <td>
                        <div class="icon-container">
                            ${[0,1,2,3].map(i => `
                                <select class="icon-dropdown" onchange="updateIcons(this, '${song}', ${i})">
                                    <option value="">-</option>
                                    <option value="O" ${songIcons[song]?.[i] === 'O' ? 'selected' : ''}>O</option>
                                    <option value="X" ${songIcons[song]?.[i] === 'X' ? 'selected' : ''}>X</option>
                                    <option value="G" ${songIcons[song]?.[i] === 'G' ? 'selected' : ''}>G</option>
                                    <option value="M" ${songIcons[song]?.[i] === 'M' ? 'selected' : ''}>M</option>
                                    <option value="→" ${songIcons[song]?.[i] === '→' ? 'selected' : ''}>→</option>
                                </select>
                            `).join('')}
                        </div>
                        <button onclick="addToSetlist('${song}', 'alternative-grunge-rock')">Add</button>
                        <select class="color-picker" onchange="updateColor(this, '${song}')">
                            <option value="#87CEEB" ${songColors[song] === '#87CEEB' ? 'selected' : ''}>Sky Blue</option>
                            <option value="#FFA500" ${songColors[song] === '#FFA500' ? 'selected' : ''}>Bright Orange</option>
                            <option value="#90EE90" ${songColors[song] === '#90EE90' ? 'selected' : ''}>Bright Green</option>
                            <option value="#FFFF00" ${songColors[song] === '#FFFF00' ? 'selected' : ''}>Yellow</option>
                            <option value="#FFC1CC" ${songColors[song] === '#FFC1CC' ? 'selected' : ''}>Pink</option>
                            <option value="#D3D3D3" ${songColors[song] === '#D3D3D3' ? 'selected' : ''}>Faded Grey</option>
                        </select>
                        <button onclick="editSong('${song}')">Edit</button>
                        <button class="delete-btn" onclick="deleteSong('${song}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        function showCrossfadePopup(song, button) {
            const popup = document.getElementById(`crossfade-${song.replace(/[^a-zA-Z0-9]/g, '')}`);
            popup.style.display = 'block';
            popup.style.left = `${button.getBoundingClientRect().left}px`;
            popup.style.top = `${button.getBoundingClientRect().bottom + window.scrollY}px`;

            // Close popup when clicking outside
            document.addEventListener('click', function closePopup(e) {
                if (!popup.contains(e.target) && e.target !== button) {
                    popup.style.display = 'none';
                    document.removeEventListener('click', closePopup);
                }
            });
        }

        function updateCrossfade(song, checkbox) {
            const selected = Array.from(document.querySelectorAll(`#crossfade-${song.replace(/[^a-zA-Z0-9]/g, '')} input:checked`)).map(input => input.value);
            if (selected.length > 3) {
                checkbox.checked = false;
                alert("You can only select up to 3 songs for crossfading.");
                return;
            }
            songData[song].crossfadeInto = selected;
        }

        function printSetlist(setlistId) {
            const songs = setlists[setlistId];
            const songCount = songs.length;
            const windowWidth = 816; // Standard letter width in pixels at 96dpi
            const windowHeight = 1056; // Standard letter height
            const maxTitleFontSize = 60; // Maximum font size for titles
            const baseTitleFontSize = Math.min(maxTitleFontSize, Math.floor((windowHeight - 100) / (songCount * 1.5)));
            const artistFontSize = 8; // Fixed artist font size
            const iconFontSize = 20; // Fixed icon font size

            let printWindow = window.open('', '', 'width=816,height=1056');
            printWindow.document.write(`
                <html><head><title>Setlist</title>
                <style>
                    body { margin: 20px; text-align: center; font-family: Arial, sans-serif; }
                    .icon-O { color: blue; font-size: ${iconFontSize}px; }
                    .icon-X { color: red; font-size: ${iconFontSize}px; }
                    .icon-G { color: #8B4513; font-size: ${iconFontSize}px; }
                    .icon-M { color: orange; font-size: ${iconFontSize}px; }
                    .icon-→ { color: black; font-size: ${iconFontSize}px; }
                    .crossfade-highlight { background-color: #90EE90; padding: 2px 5px; border-radius: 3px; }
                    h2 { font-size: ${baseTitleFontSize + 10}px; }
                    li { margin: 10px 0; display: flex; align-items: center; justify-content: center; }
                    .song-title { font-size: ${baseTitleFontSize}px; }
                    .artist { font-size: ${artistFontSize}px; margin-left: 10px; }
                    .icons { margin-right: 10px; }
                </style>
                </head><body>
                <h2>${document.getElementById(`${setlistId}-name`).value || setlistId.toUpperCase()}</h2>
                <ol>${songs.map((song, index) => {
                    const icons = (songIcons[song] || []).filter(i => i).map(icon =>
                        `<span class="icon-${icon}">${icon}</span>`
                    ).join(' ');
                    const [title, artist] = song.split(' - ');
                    const nextSong = songs[index + 1];
                    const prevSong = songs[index - 1];
                    const isCrossfadeStart = nextSong && songData[song]?.crossfadeInto?.includes(nextSong);
                    const isCrossfadeEnd = prevSong && songData[prevSong]?.crossfadeInto?.includes(song);
                    const displayText = (isCrossfadeStart || isCrossfadeEnd) 
                        ? `<span class="crossfade-highlight">---->${title}<----</span>` 
                        : title;
                    return `<li style="background:${songColors[song] || '#f9f9f9'}">
                        <span class="icons">${icons}</span>
                        <span class="song-title">${displayText}</span>
                        <span class="artist">${artist}</span>
                    </li>`;
                }).join('')}</ol>
                <button onclick="window.print()">Print</button>
                </body></html>
            `);
            printWindow.document.close();
        }

        function deleteSong(song) {
            if (confirm(`Are you sure you want to delete "${song}"?`)) {
                delete songData[song];
                delete songIcons[song];
                delete songColors[song];
                Object.keys(setlists).forEach(key => {
                    setlists[key] = setlists[key].filter(s => s !== song);
                });
                Object.keys(savedSetlists).forEach(name => {
                    savedSetlists[name] = savedSetlists[name].filter(s => s !== song);
                });
                populateSongTable();
                updateAllSetlists();
                saveData();
            }
        }

        // Rest of the script remains unchanged
        loadData();
    </script>
</body>
</html>
